name: beelab

x-django-env: &django_env
  DJANGO_SETTINGS_MODULE: config.settings
  SECRET_KEY: ${SECRET_KEY:-dev-insecure}
  DEBUG: ${DEBUG:-1}
  ALLOWED_HOSTS: ${ALLOWED_HOSTS:-*}
  # add these if keeping the old settings.py style:
  DATABASE_NAME: ${POSTGRES_DB:-app}
  DATABASE_USER: ${POSTGRES_USER:-app}
  DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-app}
  DATABASE_HOST: db
  DATABASE_PORT: "5432"
  BYPASS_MEDIA: ${BYPASS_MEDIA:-1}  

x-web-env: &web_env
  BACKEND_INTERNAL_URL: ${BACKEND_INTERNAL_URL:-http://django:8000}
  PORT: ${WEB_PORT:-3000}

x-db-env: &db_env
  POSTGRES_DB: ${POSTGRES_DB:-app}
  POSTGRES_USER: ${POSTGRES_USER:-app}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-app}

x-wp-env: &wp_env 
  WORDPRESS_DB_HOST: wpdb:3306
  WORDPRESS_DB_USER: ${WP_DB_USER:-wp}
  WORDPRESS_DB_PASSWORD: ${WP_DB_PASSWORD:-wp}
  WORDPRESS_DB_NAME: ${WP_DB_NAME:-wordpress}
  WORDPRESS_TABLE_PREFIX: ${WP_TABLE_PREFIX:-wp_}
  WORDPRESS_CONFIG_EXTRA: |
    define('WP_DEBUG', true);
    define('WP_DEBUG_LOG', true);
    define('WP_HOME', '${WP_BASE_URL}');
    define('WP_SITEURL', '${WP_BASE_URL}');


x-wpdb-env: &wpdb_env
  MYSQL_DATABASE: ${WP_DB_NAME:-wordpress}
  MYSQL_USER: ${WP_DB_USER:-wp}
  MYSQL_PASSWORD: ${WP_DB_PASSWORD:-wp}
  MYSQL_ROOT_PASSWORD: ${WP_DB_ROOT_PASSWORD:-root}
 
services:
  django:
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    build:
      context: ./django
      target:  ${DJANGO_BUILD_TARGET:-dev}
    container_name: beelab-api
    environment:
      <<: *django_env
    depends_on:
      db:
        condition: service_started
    ports:
      - "9001:8000"
    volumes:
      - ./django:/app:delegated
      # bind mount instead of named volume
      #- ./data/media:/app/media    
      #- ./data/static:/app/staticfiles 
    #command: > 
    #  bash -lc "python manage.py runserver 0.0.0.0:8000"
    healthcheck:
      test: ["CMD-SHELL","curl -fsS http://localhost:8000/ready || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
    profiles: ["dev"]

 
  web:
    build:
      context: ./web
      target: ${WEB_BUILD_TARGET:-dev}
    container_name: beelab-web
    environment:
      <<: *web_env
    ports:
      - "9080:3000"
    depends_on:
      django:
        condition: service_healthy
    volumes:
      - ./web:/app:delegated
      - web_node_modules:/app/node_modules
    command: "npx next dev -H 0.0.0.0 -p 3000"
    profiles: ["dev"]

  db:
    image: postgres:16
    container_name: beelab-db
    environment:
      <<: *db_env
    volumes:
      - db_data:/var/lib/postgresql/data
    profiles: ["dev"]
 


  wpdb:
    image: mariadb:11
    environment:
      MARIADB_DATABASE: ${WP_DB_NAME:-wordpress}
      MARIADB_USER: ${WP_DB_USER:-wp}
      MARIADB_PASSWORD: ${WP_DB_PASSWORD:-wp}
      MARIADB_ROOT_PASSWORD: ${WP_DB_ROOT_PASSWORD:-root}
    healthcheck:
      # note the double $$ to escape in compose
      test: ["CMD-SHELL", "mariadb-admin ping -h 127.0.0.1 -uroot -p$${MARIADB_ROOT_PASSWORD} --silent"]
      interval: 5s
      timeout: 5s
      retries: 20
    volumes:
      - wp_db_data:/var/lib/mysql
    profiles: ["dev"]
  
  wordpress:
    #image: wordpress:6-php8.3-apache
    image: beelab/wordpress:dev
    build:
      context: ./wordpress
    container_name: beelab-wp
    depends_on:
      wpdb:
        condition: service_healthy
    environment:
      <<: *wp_env
    ports:
      - "9082:80"
    volumes:
      - wp_data:/var/www/html
      - ./wordpress/wp-content:/var/www/html/wp-content
      - ./django/media:/var/www/html/media:ro
      - ./django/staticfiles:/var/www/html/static:ro
    profiles: ["dev"]

  wpcli:
    # service to export wordpress
    image: wordpress:cli
    user: "33:33"
    depends_on:
      wordpress:
        condition: service_started
    environment:
      WORDPRESS_DB_HOST: wpdb:3306
      WORDPRESS_DB_USER: ${WP_DB_USER:-wp}
      WORDPRESS_DB_PASSWORD: ${WP_DB_PASSWORD:-wp}
      WORDPRESS_DB_NAME: ${WP_DB_NAME:-wordpress}
    volumes:
      - wp_data:/var/www/html
      - ./wordpress/wp-content:/var/www/html/wp-content 
    working_dir: /var/www/html
    profiles: ["dev"]


volumes:
  web_node_modules:
  db_data:
  wp_db_data:
  wp_data: 



 