name: django-ml

x-django-env: &django_env
  DJANGO_SETTINGS_MODULE: config.settings
  SECRET_KEY: ${SECRET_KEY:-dev-insecure}
  DEBUG: ${DEBUG:-1}
  ALLOWED_HOSTS: ${ALLOWED_HOSTS:-*}
  # add these if keeping the old settings.py style:
  DATABASE_NAME: ${POSTGRES_DB:-app}
  DATABASE_USER: ${POSTGRES_USER:-app}
  DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-app}
  DATABASE_HOST: db
  DATABASE_PORT: "5432"
  BYPASS_MEDIA: ${BYPASS_MEDIA:-1}
x-web-env: &web_env
  BACKEND_INTERNAL_URL: ${BACKEND_INTERNAL_URL:-http://django:8000}
  PORT: ${WEB_PORT:-3000}

x-db-env: &db_env
  POSTGRES_DB: ${POSTGRES_DB:-app}
  POSTGRES_USER: ${POSTGRES_USER:-app}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-app}

services:
  django:
    build:
      context: ./django
      target: ${DJANGO_BUILD_TARGET:-dev}
    container_name: django-ml-api
    environment:
      <<: *django_env
    depends_on:
      db:
        condition: service_started
    ports:
      - "8001:8000"
    volumes:
      - ./django:/app:delegated
    command: >
      bash -lc "python manage.py migrate &&
                python manage.py runserver 0.0.0.0:8000"
    profiles: ["dev"]

  web:
    build:
      context: ./web
      target: ${WEB_BUILD_TARGET:-dev}
    container_name: django-ml-web
    environment:
      <<: *web_env
    ports:
      - "8080:3000"
    depends_on:
      django:
        condition: service_started
    volumes:
      - ./web:/app:delegated
      - web_node_modules:/app/node_modules
    command: "npx next dev -H 0.0.0.0 -p 3000"
    profiles: ["dev"]

  db:
    image: postgres:16
    container_name: django-ml-db
    environment:
      <<: *db_env
    volumes:
      - db_data:/var/lib/postgresql/data
    profiles: ["dev"]

volumes:
  web_node_modules:
  db_data:
